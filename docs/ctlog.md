# Certificate Transparency Log

This doc covers the Certificate Transparency Log which Fulcio uses to store issued certificates.
Certs are stored in a Trillian Merkle tree which are ultimately saved in a Cloud SQL Database.

## Setting up the CT Log
The CT Log public and private keypair were generated manually via:

```
openssl ec -in <(openssl ecparam -genkey -name prime256v1) -out privkey.pem -des
openssl ec -in privkey.pem -pubout -out pubkey.pem
```

The CT Log public/private keypair can be found in GCP Secret Manager:
* [ctlog-priv-key](https://console.cloud.google.com/security/secret-manager/secret/ctlog-priv-key/versions?authuser=0&project=oci-signer-service-dev)
* [ctlog-public-key](https://console.cloud.google.com/security/secret-manager/secret/ctlog-public-key/versions?authuser=0&project=oci-signer-service-dev)
* [ct-log-priv-key-password](https://console.cloud.google.com/security/secret-manager/secret/ct-log-priv-key-password/versions?authuser=0&project=oci-signer-service-dev)


From this, the CT Log config and Tree ID were generated by the CT Log Helm chart, which was deployed by Terraform `helm_release.ctlog` in [sigstore.tf](../terraform/development/signer/3-sigstore-helm/sigstore.tf).
The config and tree ID were then stored in GCP Secret Manager as a backup.
Should the Secrets in-cluster which hold the CT Log config or Tree ID be deleted, external-secrets will automatically pull them from GCP Secret Manager and replace the deleted Secret.

* [ctlog-config](https://console.cloud.google.com/security/secret-manager/secret/ctlog-config/versions?authuser=0&project=oci-signer-service-dev)
* [ctlog-treeid](https://console.cloud.google.com/security/secret-manager/secret/ctlog-treeid/versions?authuser=0&project=oci-signer-service-dev)

Setup for turning CT Log Secret Manager secrets into GKE Secrets can be found in [ctlog_config.tf](../terraform/development/signer/3-sigstore-helm/ctlog_config.tf).

## Updating the CT Log Helm Chart
The CT Log Helm chart is deployed via Terraform in [sigstore.tf](../terraform/development/signer/3-sigstore-helm/sigstore.tf).

The Helm chart is publicly available at https://github.com/sigstore/helm-charts/tree/main/charts/ctlog.

To update the CT Log Helm Chart:
1. Change the desired version in `helm_release.ctlog` in [sigstore.tf](../terraform/development/signer/3-sigstore-helm/sigstore.tf)
1. Update any values in `helm_release.ctlog` in [sigstore.tf](../terraform/development/signer/3-sigstore-helm/sigstore.tf)
1. Merge these changes into `main`
1. Deploy the updated Terraform as described in [Deploying Terraform via Github Actions](./infrastructure-sigstore.md#deploying-terraform-via-github-actions)

### Support
For questions around the CT Log, reach out to these Sigstore Slack chanels:
* [#general](https://sigstore.slack.com/archives/C01DGF0G8U9)
